# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

「betrayer2」は、戦略シミュレーションゲームのUnityプロジェクト。三国志風の政治・戦闘・外交システムを持つゲームです。

## コア技術スタック

- **Unity 2023.x**
- **C#**
- **UI Toolkit**
- **Unity Input System**: 入力管理
- **Rosalina**: UI ToolkitのUXMLのidを元にC#のアクセッサーを自動生成するライブラリ
- **Unity Localization**: （導入しているものの今回は使用しない。日本語のみ対応する）

## アーキテクチャ構造

### メインゲームコア
- `GameCore` (Assets/Main/System/GameCore.cs): ゲーム全体の制御中枢
  - シングルトンパターンで実装
  - メインループ（`DoMainLoop()`）で日単位のゲーム進行を管理
  - 世界データ（`WorldData`）、UI、AI、アクションシステムを統合管理

### データ管理
- `WorldData`: ゲーム世界の状態を保持
- `GameDate`: ゲーム内時間管理（月・年単位の処理含む）
- 収入システム、忠誠度、友好度の自動更新機能

### アクションシステム
- `ActionsBase<T>`: アクション基底クラス
- `PersonalActions`: 個人レベルのアクション（開発、訓練等）
- `StrategyActions`: 戦略レベルのアクション（同盟、投資等）
- コスト・実行可能条件・実行処理の統一インターフェース

### UI管理
- Rosalinaライブラリによる自動生成システム
- `MainUI`: メインゲーム画面
- `TitleSceneUI`: タイトル画面
- UXMLファイルとC#コードの連携

### バトルシステム
- `Battle`/`BattleManager`: 戦闘処理
- `CharacterInBattle`: 戦闘中のキャラクター状態
- 兵士の自動回復、連戦ペナルティシステム

## 開発時の注意点

### Rosalinaワークフロー
- UXMLファイル編集後、自動生成コード（`.g.cs`）が更新される
- `Assets/Rosalina/AutoGenerated/`内のファイルは直接編集不可

### ローカライゼーション
- （今回は日本語のみ対応するので気にしないでください）
- 開発元のソースは英語対応していたため、中途半端に対応コードがある場合がありますが無視してください

### AI・ゲームバランス
- AIは`AI.cs`で実装
- キャラクターの性格（平和主義・攻撃的等）が行動パターンに影響
- 収入・支出・忠誠度の複雑な経済システム

### パフォーマンス
- 非同期処理（`async/await`）を多用
- メインループは`Awaitable.WaitForSecondsAsync()`で調整
- 大量の軍勢・キャラクター処理を効率化

## デバッグ・テスト
- `Testing.cs`: ゲーム進行の一時停止・速度調整
- エディタ拡張: `TileInfoEditorWindow.cs`でマップ情報編集

このゲームは複雑な政治・経済・戦闘システムを持つため、変更時は連鎖的な影響を慎重に検討してください。


## フォルダー構造 (ルートレベル)
```
betrayer2/
├── @参考ソース_betrayer1/       # 前作のソース(参考用)
├── Assets/                     # Unityメインアセット
├── Packages/                   # Unity Package Manager
├── ProjectSettings/           # Unityプロジェクト設定
├── Library/                   # Unity一時ファイル（Git除外）
├── CLAUDE.md                  # Claude Code用ドキュメント
└── *.sln, *.csproj           # Visual Studio ソリューション
```

## Assets フォルダー構造

### Main/ - ゲームコア
```
Assets/Main/
├── Actions/                   # アクションシステム
│   ├── Actions.cs            # アクション基底クラス
│   ├── Personal.*.cs         # 個人アクション（開発、訓練等）
│   └── Strategy.*.cs         # 戦略アクション（同盟、投資等）
├── Battle/                   # 戦闘システム
│   ├── Battle.cs             # 戦闘処理
│   ├── BattleManager.cs      # 戦闘管理
│   └── CharacterInBattle.cs  # 戦闘中キャラ状態
├── Static/                   # 静的データ管理
│   ├── Static.cs
│   ├── FaceImageManager.cs   # キャラ顔画像管理
│   └── SoldierImageManager.cs
├── System/                   # ゲームシステム
│   ├── GameCore.cs           # ゲーム制御中枢（シングルトン）
│   ├── GameCore.Move.cs      # ゲーム制御（移動系）
│   ├── Util.cs               # ユーティリティ
│   ├── AI/                   # AI関連
│   └── Data/                 # データ構造
│       ├── Character/        # キャラクター関連
│       ├── Map/             # マップ関連
│       ├── Save/            # セーブデータ
│       └── World/           # ワールドデータ
├── Tiles/                    # マップタイル
│   ├── CountryTile/         # 国境タイル
│   ├── HexBorderTile/       # ヘックス境界
│   ├── HexTerrainTile/      # ヘックス地形
│   └── Images/              # タイル画像
├── UI/                       # ユーザーインターフェース
│   ├── MainUI.cs            # メインUI制御
│   ├── MainUI.uxml          # メインUIレイアウト
│   ├── MainUI.uss           # メインUIスタイル
│   ├── MainUIFrame.cs       # UIフレーム
│   ├── Parts/               # UI部品
│   ├── Windows/             # ウィンドウ
│   └── Images/              # UI画像
├── CameraMovement.cs         # カメラ制御
├── UIMapManager.cs           # UIマップ管理
├── Testing.cs                # デバッグ・テスト機能
└── TestPalette.prefab        # テスト用パレット
```

### Title/ - タイトル画面
```
Assets/Title/
├── TitleScene.unity          # タイトルシーン
├── TitleSceneManager.cs      # タイトル管理
└── UI/                       # タイトルUI
    ├── TitleSceneUI.cs
    ├── TitleSceneUI.uxml
    ├── TitleSceneUI.uss
    └── Windows/
```

### Resources/ - リソース
```
Assets/Resources/
├── CharacterImages/          # キャラクター顔画像（0000.jpg～）
└── Scenarios/               # シナリオデータ
    ├── 01/                  # シナリオ1
    └── tmp/                 # 一時シナリオ
```

### Development/ - 開発ツール
```
Assets/Development/
├── Editor/                   # エディター拡張
│   └── TileInfoEditorWindow.cs # タイル情報編集ウィンドウ
└── FaceGenerator~/           # 顔画像生成ツール（Python）
    ├── requirements.txt
    └── test.ipynb
```

### _Misc/ - その他設定
```
Assets/_Misc/
├── Localization/             # 多言語対応（今回は未使用）
├── Settings/                 # レンダリング設定
│   ├── UniversalRP.asset     # URP設定
│   ├── Renderer2D.asset      # 2Dレンダラー
│   └── Scenes/               # シーンテンプレート
└── *.asset                   # 各種設定ファイル
```

### External/ - 外部ライブラリ
```
Assets/External/
└── TextMesh Pro/             # TextMeshPro関連リソース
```

### Rosalina/ - UI自動生成
```
Assets/Rosalina/
└── AutoGenerated/            # 自動生成されたC#コード
```
